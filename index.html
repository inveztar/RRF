<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Resonance Finder (Backup · Backoffice)</title>
<meta name="color-scheme" content="dark">
<style>
:root{--bg:#0e1320;--card:#0f1727;--border:#1f2a44;--text:#e5e7eb;--muted:#9aa4b2;--accent:#69a8ff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:13px ui-sans-serif,system-ui}
.wrap{max-width:900px;margin:22px auto;padding:0 12px}
h1{margin:0 0 8px;font:600 20px ui-sans-serif}.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{border:0;border-radius:9px;padding:8px 12px;font-weight:700;cursor:pointer;background:var(--accent);color:#061120}
.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
table{width:100%;border-collapse:collapse;table-layout:fixed}th,td{padding:7px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
tbody tr{height:30px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}.hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Resonance Finder (Backup)</h1>
  <div class="row" style="margin-bottom:8px">
    <button id="start">Start</button>
    <button id="stop" class="ghost">Stop</button>
  </div>
  <div class="card">
    <div class="row">
      <label>Top-N <select id="topN"><option>3</option><option selected>5</option><option>7</option></select></label>
      <label>Range <input id="minHz" type="number" value="20" style="width:90px"> – <input id="maxHz" type="number" value="300" style="width:90px"></label>
      <label>Prom ≥ <input id="prom" type="number" value="6" step="0.5" style="width:90px"> dB</label>
    </div>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>Hz</th><th>Level</th><th>Prom</th><th>Hold</th><th>PEQ</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="hint">ตารางแถวคงที่ตาม Top‑N เพื่อไม่ให้ดีด</div>
  </div>
</div>
<script>
(()=>{"use strict";
const rows=document.querySelector("#rows");
const st={ctx:null,src:null,an:null,run:false,raf:0,sr:48000,bin:0,rowPool:[],hold:new Map(),buf:null};
function db2lin(db){return Math.pow(10,db/20)} function lin2db(l){return 20*Math.log10(Math.max(l,1e-12))}
function hz2note(hz){const m=69+12*Math.log2(hz/440),mi=Math.round(m),nm=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][((mi%12)+12)%12],oc=Math.floor(mi/12)-1;return nm+oc}
async function start(){try{if(st.run)return;const s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});st.ctx=new (window.AudioContext||window.webkitAudioContext)();st.src=st.ctx.createMediaStreamSource(s);st.an=st.ctx.createAnalyser();st.an.fftSize=8192;st.an.smoothingTimeConstant=0;st.src.connect(st.an);st.sr=st.ctx.sampleRate;st.bin=(st.sr/2)/st.an.frequencyBinCount;loop()}catch(e){alert("ไมโครโฟนไม่พร้อม");console.error(e)}}
function stop(){st.run=false;cancelAnimationFrame(st.raf);if(st.ctx){st.ctx.close().catch(()=>{});st.ctx=null}}
function ensureRows(n){if(st.rowPool.length===n)return;rows.innerHTML="";st.rowPool=[];for(let i=0;i<n;i++){const tr=document.createElement("tr");tr.innerHTML=`<td class="mono hz">—</td><td class="mono lvl">—</td><td class="mono prm">—</td><td class="mono hld">—</td><td class="mono peq">—</td>`;rows.appendChild(tr);st.rowPool.push({hz:tr.children[0],lvl:tr.children[1],prm:tr.children[2],hld:tr.children[3],peq:tr.children[4]})}}
function pick(db,minHz,maxHz,promTop,topN){const n=db.length,iMin=Math.max(1,Math.floor(minHz/st.bin)),iMax=Math.min(n-2,Math.ceil(maxHz/st.bin));const out=[];for(let i=iMin;i<=iMax;i++){const v=db[i];if(!(v>db[i-1]&&v>db[i+1]))continue;let L=v,R=v,j=i;while(j>iMin&&db[j-1]<L)L=db[--j];j=i;while(j<iMax&&db[j+1]<R)R=db[++j];const base=Math.max(L,R),prom=v-base;if(prom>=promTop)out.push({i,f=i*st.bin,v,prom})}out.sort((a,b)=>b.prom-a.prom);return out.slice(0,topN)}
function estQ(db,idx){const v=db[idx],th=v-3;let l=idx,r=idx;while(l>1&&db[l]>th)l--;while(r<db.length-2&&db[r]>th)r++;const f0=idx*st.bin,bw=Math.max((r-l)*st.bin,1e-6);return Math.max(1,Math.min(f0/bw,20))}
let last=performance.now();
function loop(){st.run=true;st.raf=requestAnimationFrame(loop);const n=st.an.frequencyBinCount;st.buf=st.buf&&st.buf.length===n?st.buf:new Float32Array(n);st.an.getFloatFrequencyData(st.buf);
const minHz=parseFloat(document.querySelector("#minHz").value)||20,maxHz=parseFloat(document.querySelector("#maxHz").value)||300,prom=parseFloat(document.querySelector("#prom").value)||6,topN=parseInt(document.querySelector("#topN").value,10)||5;
ensureRows(topN);
const now=performance.now(),dt=Math.min(1,(now-last)/1000);last=now;
const peaks=pick(st.buf,minHz,maxHz,prom,topN).sort((a,b)=>a.f-b.f);
const nh=new Map();peaks.forEach(p=>{const k=Math.round(p.f),t=(st.hold.get(k)||0)+dt;nh.set(k,t);p.hold=t});st.hold=nh;
for(let i=0;i<st.rowPool.length;i++){const r=st.rowPool[i];if(i<peaks.length){const p=peaks[i],Q=estQ(st.buf,p.i),gain=Math.max(-6,-Math.round(p.prom/1.2));r.hz.innerHTML=`${p.f.toFixed(1)} <span class="hint">(${hz2note(p.f)})</span>`;r.lvl.textContent=p.v.toFixed(1);r.prm.textContent=p.prom.toFixed(1);r.hld.textContent=(p.hold||0).toFixed(1);r.peq.textContent=`${p.f.toFixed(0)}Hz · Q≈${Q.toFixed(1)} · ${gain}dB`}else{r.hz.textContent="—";r.lvl.textContent="—";r.prm.textContent="—";r.hld.textContent="—";r.peq.textContent="—"}}
}
document.querySelector("#start").onclick=start; document.querySelector("#stop").onclick=stop;
})();</script>
</body>
</html>
