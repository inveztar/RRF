<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Resonance Watch — หาเรโซแนนซ์จากไมค์จริง (v2.2)</title>

<!--
แพตช์ v2.2 (วันนี้)
- เปลี่ยน "หลอดคะแนน" กลับเป็นสไตล์เดิม (gradient pill) สีฟ้า->ชมพู
- ลดขนาดตัวหนังสือในมือถือ (หัวข้อ/ค่า/บรรทัดอธิบาย) ให้สมส่วนมากขึ้น
- ย่อข้อความอธิบายใต้กล่อง Score ให้เล็กลง
- คงพฤติกรรมตาราง 3 แถวล็อกไม่เด้ง และยังมี smoothing + gate ตามเวอร์ชันก่อน
-->

<style>
:root{
  --bg:#0f1720; --panel:#121a24; --muted:#6b859f; --text:#eaf2ff; --accent:#28d7ff; --accent2:#ffa0a8;
  --good:#57e5ff; --line:#213041;
  --fs-h1:clamp(20px,4.6vw,30px);
  --fs-h2:clamp(16px,3.6vw,22px);
  --fs-big:clamp(26px,6vw,38px);
  --fs-mid:clamp(14px,3.2vw,18px);
  --fs-small:clamp(12px,2.7vw,14px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);font:400 16px/1.45 ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
}
.wrap{max-width:1100px;margin:auto;padding:18px;display:grid;gap:14px}

/* panels */
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
.card h3{margin:0 0 10px;font-size:var(--fs-h2)}
h2{font-size:var(--fs-h1);margin:2px 0 8px}

/* controls */
.controls{display:grid;gap:10px}
.controls .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,.btn{
  background:#163248;border:1px solid #27465f;color:#dff6ff;
  padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer
}
button.primary{background:#1a4765;border-color:#226486}
input[type="number"],input[type="text"]{
  background:#0e1a25;border:1px solid #2b4257;color:#d3eaff;border-radius:10px;padding:8px 10px;width:120px
}
.range{display:flex;align-items:center;gap:8px}
.range input[type="range"]{width:160px}
.help{color:var(--muted);font-size:12px}

/* tables */
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{padding:9px;border-top:1px solid var(--line);text-align:left;font-size:var(--fs-small)}
.tbl th{color:#bcd0e7;font-weight:700}
.tbl tr:first-child td{border-top:none}
.fix3{min-height:160px}

/* Top winners */
.small-note{color:#9fd3ff;font-weight:700;margin-left:6px}

/* Likelihood cards */
.grid3{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
.lcard{border-radius:14px;border:1px solid var(--line);background:#0f1924;padding:14px;position:relative}
.lhz{display:flex;align-items:center;gap:8px;font-size:var(--fs-mid)}
.badge{
  display:inline-flex;align-items:center;justify-content:center;
  padding:4px 10px;border-radius:999px;background:#14bde2;color:#062230;font-weight:900
}
.scoreNum{font-size:var(--fs-big);font-weight:900;margin:6px 0 6px}

/* gradient pill (สไตล์เดิม) */
.score-track{
  background:#0d2232;border-radius:999px;height:12px;position:relative;overflow:hidden;
  box-shadow:inset 0 0 0 1px #1b3346, inset 0 6px 12px #0b1926;
}
.score-fill{
  position:absolute;left:0;top:0;bottom:0;width:0%;
  background:linear-gradient(90deg,#65e7f7 0%, #60b8ff 45%, #ffa3ad 100%);
  box-shadow:0 0 10px rgba(96,184,255,.35),0 0 14px rgba(255,160,168,.18);
  border-radius:999px;
  transition:width .45s cubic-bezier(.22,.61,.36,1);
}
.metrics{margin-top:6px;color:#b9cfe7;font-size:13px;letter-spacing:.2px}
.noteBadge{font-weight:800}

/* caption under bars */
.caption{color:#9fbbd4;font-size:12px}

/* mobile refinements */
@media (max-width:560px){
  .metrics{font-size:12px}
  .caption{font-size:11.5px}
  .lhz .noteBadge{font-size:14px}
  .scoreNum{margin:4px 0 6px}
}
</style>
</head>
<body>
<div class="wrap">

  <h2>Resonance Watch — หาเรโซแนนซ์จากไมค์จริง <small style="color:#7fa8c9;font-size:12px">v2.2</small></h2>

  <!-- Controls -->
  <div class="card controls">
    <h3>ควบคุม</h3>
    <div class="row">
      <button id="btnStart" class="primary">เริ่มวัด</button>
      <button id="btnStop">หยุด</button>
      <button id="btnClear">Clear สถิติ</button>
    </div>

    <div class="row">
      <label>ย่านตรวจ: </label>
      <input id="minHz" type="number" value="40"> –
      <input id="maxHz" type="number" value="300"> Hz
    </div>

    <div class="row range">
      <label>Count Gate ≥</label>
      <input id="gate" type="range" min="-70" max="-20" step="1" value="-40">
      <span id="gateVal">-40 dBFS</span>
    </div>
    <div class="help">* จะนับสถิติ Top Winner เฉพาะคลิปที่ “พีคอันดับ1” และมีระดับสูงกว่า Gate เท่านั้น เพื่อลดนอยซ์/ช่วงเงียบ</div>
  </div>

  <!-- Watchlist -->
  <div class="card">
    <h3>Watchlist</h3>
    <div class="row">
      <input id="watchIn" type="text" placeholder="Hz หรือ โน้ต เช่น B2" style="flex:1 1 200px">
      <button id="btnAddWatch">Add</button>
      <button id="btnClearWatch">Clear Watchlist</button>
    </div>
    <div id="watchlist" class="help" style="margin-top:8px">—</div>
  </div>

  <!-- Current peaks -->
  <div class="card fix3">
    <h3>พีคปัจจุบัน (ล็อก 3 แถว)</h3>
    <table class="tbl" id="peaksTbl">
      <thead><tr><th>Hz</th><th>Level (dBFS)</th><th>Prom. (dB)</th><th>Hold (s)</th><th>Decay (s)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Top winners -->
  <div class="card fix3">
    <h3>Top Winners (3 อันดับ)</h3>
    <table class="tbl" id="winnersTbl">
      <thead><tr><th>Hz</th><th>นับครั้ง</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="help">* นับเมื่อ Max Peak ชนะและสูงเกิน Gate</div>
  </div>

  <!-- Likelihood -->
  <div class="card">
    <h3>Resonance Likelihood (Score)</h3>
    <div class="grid3" id="scoreGrid"></div>
    <div class="caption" style="margin-top:10px">
      คะแนนคิดจาก Prominence (0–12dB), Hold (0–3s), Count (เทียบกับอันดับสูงสุด), Decay (0–1.5s) — ถ่วงน้ำหนัก 30/30/20/20<br>
      ผลลัพธ์ขึ้นกับไมค์และสภาพแวดล้อม ใช้ร่วมกับการลองปรับ EQ/ยืนตำแหน่ง room mode
    </div>
  </div>

</div>

<script>
/* ===== Utilities ===== */
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function hzToNoteName(freq){
  const A4=440, n=Math.round(12*Math.log2(freq/A4));
  const nn=(n+9+1200)%12; // +9 ให้ A->index=9->A
  const octave = Math.round(4 + (n+9)/12);
  return noteNames[nn] + octave;
}
const lerp=(a,b,t)=>a+(b-a)*t;
const clamp=(v,lo,hi)=>Math.min(hi,Math.max(lo,v));

/* ===== State ===== */
let audio, analyser, dataArray;
let running=false;
const SMOOTH=0.35; // ให้สัญญาณนิ่งขึ้น
let gateDB=-40;

const peakHistory = [];        // เก็บ peak ล่าสุด (Hz/level/prom/hold/decay)
const winnersCount = new Map();// Hz -> count
const bestBuckets = [];        // คะแนน 3 อันดับ

/* Watchlist */
const watch = new Set();

/* ===== DOM ===== */
const elPeaksBody   = document.querySelector('#peaksTbl tbody');
const elWinnersBody = document.querySelector('#winnersTbl tbody');
const elScoreGrid   = document.getElementById('scoreGrid');

function fmt(n,dp=1){return (isFinite(n)?n:0).toFixed(dp)}
function renderPeaks(rows){
  elPeaksBody.innerHTML = '';
  const show = [...rows];
  while(show.length<3) show.push({hz:'—',level:'—',prom:'—',hold:'—',decay:'—'});
  for(const r of show){
    const tr=document.createElement('tr');
    if(r.hz==='—'){
      tr.innerHTML = `<td>—</td><td>—</td><td>—</td><td>—</td><td>—</td>`;
    }else{
      tr.innerHTML = `<td>${fmt(r.hz,0)} <span class="small-note">(${hzToNoteName(r.hz)})</span></td>
        <td>${fmt(r.level,1)}</td><td>${fmt(r.prom,1)}</td><td>${fmt(r.hold,2)}</td><td>${fmt(r.decay,2)}</td>`;
    }
    elPeaksBody.appendChild(tr);
  }
}

function renderWinners(){
  // เอา top 3 ตาม count
  const arr=[...winnersCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
  elWinnersBody.innerHTML='';
  while(arr.length<3) arr.push(['—', '—']);
  for(const [hz,count] of arr){
    const tr=document.createElement('tr');
    if(hz==='—') tr.innerHTML=`<td>—</td><td>—</td>`;
    else tr.innerHTML=`<td>${fmt(hz,0)} <span class="small-note">(${hzToNoteName(hz)})</span></td><td>${count}</td>`;
    elWinnersBody.appendChild(tr);
  }
}

function renderScores(){
  // เลือกระดับจาก winners เป็นฐาน แล้วจับ 3 ความถี่ที่คะแนนสูงสุดใน snapshot ล่าสุด
  const list=[...bestBuckets].slice(0,3);
  while(list.length<3) list.push(null);
  elScoreGrid.innerHTML='';
  list.forEach((item,idx)=>{
    const wrap=document.createElement('div'); wrap.className='lcard';
    if(!item){
      wrap.innerHTML = `<div class="lhz">—</div><div class="scoreNum">—</div>
        <div class="score-track"><div class="score-fill" style="width:0%"></div></div>
        <div class="metrics">P:— · H:— · C:— · D:—</div>`;
      elScoreGrid.appendChild(wrap); return;
    }
    const {hz,score,p,pHold,pCount,pDecay}=item;
    const note=hzToNoteName(hz);
    const scorePct=clamp(score,0,100);
    wrap.innerHTML = `
      <div class="lhz">
        <span style="font-size:var(--fs-big);font-weight:900">${fmt(hz,0)}</span>
        <span style="font-size:var(--fs-mid)">Hz</span>
        <span class="badge noteBadge">${note}</span>
      </div>
      <div class="scoreNum">${fmt(scorePct,1)}</div>
      <div class="score-track"><div class="score-fill" style="width:${scorePct}%"></div></div>
      <div class="metrics">P:${fmt(p*100,0)}% · H:${fmt(pHold*100,0)}% · C:${fmt(pCount*100,0)}% · D:${fmt(pDecay*100,0)}%</div>`;
    elScoreGrid.appendChild(wrap);
  });
}

/* คะแนน: normalize และถ่วงน้ำหนัก 30/30/20/20 */
function calcScore(row, maxRef){
  const prom = clamp(row.prom,0,12)/12;       // 0–12 dB
  const hold = clamp(row.hold,0,3)/3;         // 0–3 s
  const decay= 1 - clamp(row.decay,0,1.5)/1.5;// decay น้อยยิ่งดี
  const cnt  = maxRef>0 ? clamp((winnersCount.get(Math.round(row.hz))||0)/maxRef,0,1):0;

  // น้ำหนัก
  const wP=0.30,wH=0.30,wC=0.20,wD=0.20;
  const score = (prom*wP + hold*wH + cnt*wC + decay*wD)*100;

  return {score,p:prom,pHold:hold,pCount:cnt,pDecay:decay};
}

/* ===== Audio / FFT ===== */
async function start(){
  if(running) return;
  running=true;

  const stream=await navigator.mediaDevices.getUserMedia({audio:{
    echoCancellation:true,noiseSuppression:true,autoGainControl:false
  }});
  audio = new (window.AudioContext||window.webkitAudioContext)();
  const src=audio.createMediaStreamSource(stream);
  analyser=audio.createAnalyser();
  analyser.fftSize=4096;
  analyser.smoothingTimeConstant=0.8; // ช่วยนิ่ง
  src.connect(analyser);

  const bufLen=analyser.frequencyBinCount;
  dataArray=new Float32Array(bufLen);

  loop();
}
function stop(){
  running=false;
  if(audio){audio.close();audio=null;}
}

function loop(){
  if(!running) return;
  analyser.getFloatFrequencyData(dataArray);

  // หา peak ในช่วง min-max
  const min=parseFloat(minHz.value)||40;
  const max=parseFloat(maxHz.value)||300;
  gateDB=parseFloat(gate.value)||-40;
  document.getElementById('gateVal').textContent = `${gateDB} dBFS`;

  const nyquist = audio.sampleRate/2;
  const hzPerBin=nyquist/dataArray.length;

  // หาค่า prominence แบบคร่าวๆ: ความต่างจากเพื่อนบ้าน
  let peaks=[];
  for(let i=Math.floor(min/hzPerBin)+2;i<Math.floor(max/hzPerBin)-2;i++){
    const lvl=dataArray[i];
    if(!isFinite(lvl)) continue;
    const left =(dataArray[i-2]+dataArray[i-1])/2;
    const right=(dataArray[i+1]+dataArray[i+2])/2;
    const prom = (Math.max(left,right) - lvl)*-1;
    // ค่าลบ -> กลับเครื่องหมายให้เป็นบวก dB
    const freq=i*hzPerBin;
    peaks.push({hz:freq,level:lvl,prom});
  }
  peaks.sort((a,b)=>b.prom-a.prom);
  const top=peaks.slice(0,3);

  // อัปเดต Hold/Decay (อย่างง่าย)
  const now=performance.now()/1000;
  top.forEach(p=>{
    const prev=peakHistory.find(x=>Math.abs(x.hz-p.hz)<hzPerBin*1.5);
    if(prev){
      // smoothing level/prom
      p.level = lerp(prev.level,p.level,SMOOTH);
      p.prom  = lerp(prev.prom ,p.prom ,SMOOTH);
      p.hold  = (prev.hold||0) + (1/12);   // ประมาณเวลา frame
      p.decay = prev.decay? lerp(prev.decay, Math.max(0,prev.decay-0.05), .5):0;
      p.t=now;
    }else{
      p.hold=0.1;p.decay=0;p.t=now;
    }
  });
  // เก็บไว้เป็น history ย่อ
  peakHistory.length=0; peakHistory.push(...top);

  // ตัดสินผู้ชนะ (อันดับ 1) + gate
  if(top[0] && top[0].level>=gateDB){
    const key=Math.round(top[0].hz);
    winnersCount.set(key,(winnersCount.get(key)||0)+1);
  }

  // เรนเดอร์
  renderPeaks(top);

  // winners + score
  renderWinners();

  // คำนวณคะแนน 3 ตัวน่าเป็นไปได้จาก Peak 3 ตัว
  const maxRef = Math.max(1, ...[...winnersCount.values()]);
  bestBuckets.length=0;
  top.forEach(p=>{
    const sc=calcScore(p,maxRef);
    bestBuckets.push({...p,...sc});
  });
  bestBuckets.sort((a,b)=>b.score-a.score);
  renderScores();

  requestAnimationFrame(loop);
}

/* ===== Events ===== */
document.getElementById('btnStart').onclick=start;
document.getElementById('btnStop').onclick=stop;
document.getElementById('btnClear').onclick=()=>{
  winnersCount.clear(); renderWinners(); renderScores();
};
document.getElementById('btnAddWatch').onclick=()=>{
  const v=watchIn.value.trim();
  if(!v) return;
  const hz = /^[0-9.]+$/.test(v)? parseFloat(v) : noteToHz(v);
  if(!isFinite(hz)) return;
  watch.add(Math.round(hz));
  watchIn.value='';
  drawWatch();
};
document.getElementById('btnClearWatch').onclick=()=>{watch.clear();drawWatch();};

function drawWatch(){
  const arr=[...watch].sort((a,b)=>a-b);
  watchlist.textContent = arr.length? arr.map(h=>`${h} Hz (${hzToNoteName(h)})`).join(', ') : '—';
}

/* optional: แปลงโน้ตเป็น Hz (A4=440) */
function noteToHz(s){
  const m = s.toUpperCase().match(/^([A-G])(#|B)?(\d)$/);
  if(!m) return NaN;
  const map = {C:0,'C#':1,DB:1,D:2,'D#':3,EB:3,E:4,F:5,'F#':6,GB:6,G:7,'G#':8,AB:8,A:9,'A#':10,BB:10,B:11};
  const name = m[1]+(m[2]||'');
  const n = map[name]; const oct=parseInt(m[3],10);
  const midi = n + (oct+1)*12; // C-1=0
  return 440*Math.pow(2,(midi-69)/12);
}

/* init placeholders */
renderPeaks([]);
renderWinners();
renderScores();
</script>
</body>
</html>
