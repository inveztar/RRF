<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Resonance Watch — หาเรโซแนนซ์จากไมค์จริง</title>
<style>
:root{
  --bg:#0e1921;
  --panel:#111d27;
  --muted:#98a7b5;
  --text:#e7f1fb;
  --accent:#5cd9ff;
  --accent-2:#f79ac0;
  --good:#3ddc97;
  --warn:#ffd166;
  --bad:#ef476f;
  --chip:#0e2b3a;
  --chip-text:#bfeaff;
  --card-shadow: 0 6px 20px rgba(0,0,0,.35);
}
*,*:before,*:after{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: ui-sans-serif,system-ui,"Segoe UI",Inter,"Helvetica Neue",Arial;
  line-height:1.35;
}
.container{
  max-width:1100px;
  margin:28px auto 72px;
  padding:0 16px;
}
h1{
  font-size:26px;
  margin:0 0 12px;
  letter-spacing:.2px;
}
small.ver{opacity:.7;font-size:12px;margin-left:8px}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.card{
  background:var(--panel);
  border-radius:14px;
  padding:16px;
  box-shadow:var(--card-shadow);
}
/* Controls */
.controls{
  display:flex;flex-wrap:wrap;gap:10px;align-items:center
}
.btn{
  background:#173041;
  color:var(--text);
  border:1px solid #1e4159;
  padding:8px 14px;border-radius:10px;
  font-weight:600;cursor:pointer
}
.btn.secondary{background:#0f2634;border-color:#173041;color:#cfe6ff}
.btn:disabled{opacity:.6;cursor:not-allowed}
.input, select{
  background:#0e2837;color:var(--text);
  border:1px solid #1a4058;border-radius:9px;
  padding:8px 10px;min-width:84px;
}
label{color:#a7bccb;font-size:12px;margin-right:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.range-wrap{display:flex;align-items:center;gap:8px}
.range{accent-color:var(--accent)}
.badge{
  background:var(--chip);
  color:var(--chip-text);
  padding:2px 8px;border-radius:999px;
  font-weight:800;letter-spacing:.5px;
  display:inline-flex;align-items:center;gap:6px;
  white-space:nowrap;font-size:12px;
  border:1px solid #1f4259;
}

/* Tables */
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:8px;border-bottom:1px solid #162432}
.table th{color:#aac1d6;font-weight:700;text-align:left}
.table td{color:#e6f5ff}
.table .muted{color:#95a9ba}
.sticky3{min-height:210px} /* lock height to prevent jumping */

/* Top winners bubble note */
.note-badge {
  display:inline-block;
  background:#0b2a3a;
  border:1px solid #1b4258;
  color:#bfeaff;
  border-radius:999px;
  padding:2px 7px;
  font-weight:800;
  letter-spacing:.5px;
  margin-left:6px;
  font-size:12px;
  white-space:nowrap;
}

/* SCORE CARDS */
#rl-score{margin-top:14px}
.score-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:16px;
}
.score-card{
  background:var(--panel);
  padding:16px 16px 14px;
  border-radius:14px;
  box-shadow:var(--card-shadow);
  display:flex;flex-direction:column;gap:8px;
  min-height:180px; /* lock height/anti jump */
}
.score-top{display:flex;align-items:center;gap:8px;justify-content:space-between}
.hz-wrap{display:flex;gap:6px;align-items:baseline}
.hz{font-size:22px;font-weight:800}
.note{font-size:12px;opacity:.85}
.status-chip{
  background:#0b2a3a;border:1px solid #1b4258;
  color:#cde9ff;padding:3px 8px;border-radius:999px;
  font-weight:800;font-size:12px;white-space:nowrap
}
.bigscore{font-size:34px;font-weight:900;letter-spacing:1.2px}
/* gradient pill bar */
.bar{
  position:relative;height:10px;border-radius:999px;
  background:#0a2534;border:1px solid #16394c;overflow:hidden;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.25);
}
.bar .fill{
  position:absolute;left:0;top:0;height:100%;
  background:linear-gradient(90deg,#52d1ff 0%, #66c7ff 25%, #93b9ff 55%, #f79ac0 100%);
  border-radius:999px;box-shadow:0 3px 10px rgba(245,135,185,.35);
  width:0%;
  transition:width .35s cubic-bezier(.2,.8,.2,1);
}
.score-meta{color:#b7c9d9;font-size:12px;margin-top:2px}
.score-meta b{color:#e9f7ff}

/* watchlist chips */
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.chip{
  background:#0e2837;border:1px solid #1a4058;color:#cfe6ff;
  padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px
}

/* responsive */
@media (max-width:900px){
  .grid{grid-template-columns:1fr}
  .score-grid{grid-template-columns:1fr}
}
@media (max-width:520px){
  .hz{font-size:18px}
  .bigscore{font-size:28px}
  .status-chip,.badge,.note-badge{font-size:11px;padding:2px 7px}
  .score-meta{font-size:11px}
  .table{font-size:13px}
  .desc{font-size:13px}
}
/* subtle separators */
.hr{height:1px;background:#163042;margin:10px 0 6px;opacity:.65}
.muted{color:#a0b3c3}
</style>
</head>
<body>
  <div class="container">
    <h1>Resonance Watch — หาเรโซแนนซ์จากไมค์จริง <small class="ver">v2.2</small></h1>

    <!-- Controls and Watchlist -->
    <div class="grid">
      <div class="card">
        <div class="controls">
          <button id="startBtn" class="btn">เริ่มวัด</button>
          <button id="stopBtn" class="btn secondary" disabled>หยุด</button>
          <button id="clearBtn" class="btn secondary">Clear สถิติ</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <label>ย่านตรวจ:</label>
          <input id="minHz" class="input" type="number" value="40" min="1" max="5000" style="width:86px"> 
          <span class="muted">–</span>
          <input id="maxHz" class="input" type="number" value="300" min="1" max="5000" style="width:96px">
          <span class="muted">Hz</span>
        </div>
        <div class="row" style="margin-top:10px">
          <label>Count Gate ≥</label>
          <div class="range-wrap">
            <input id="gate" class="range" type="range" min="-100" max="-10" value="-40" step="1" style="width:220px">
            <span id="gateVal" class="badge">-40 dBFS</span>
          </div>
        </div>
        <div class="muted" style="margin-top:10px;font-size:12px">
          * จะนับสถิติ Top Winner เฉพาะคลิปที่ “พีคอันดับ1” และมีระดับสูงกว่า Gate เท่าที่กำหนด เพื่อคัดคนอยู่วงจรเสียงรบกวน
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label>Watchlist</label>
          <input id="watchInput" class="input" placeholder="Hz หรือ โน้ต เช่น B2" style="min-width:180px">
          <button id="addWatch" class="btn">Add</button>
          <button id="clearWatch" class="btn secondary">Clear Watchlist</button>
        </div>
        <div id="watchChips" class="chips"></div>
      </div>
    </div>

    <!-- Current Peaks -->
    <div class="card sticky3" style="margin-top:16px">
      <div class="row" style="justify-content:space-between">
        <div class="badge">พีคล่าสุด (ล็อค 3 แถว)</div>
      </div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th>Hz</th><th>Level (dBFS)</th><th>Prom. (dB)</th><th>Hold (s)</th><th>Decay (s)</th></tr></thead>
        <tbody id="peaksBody">
          <tr><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td></tr>
          <tr><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td></tr>
          <tr><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Top winners -->
    <div class="card sticky3" style="margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <div class="badge">Top Winners (3 อันดับ)</div>
      </div>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Hz</th><th>นับครั้ง</th></tr></thead>
        <tbody id="winnersBody">
          <tr><td class="muted">—</td><td class="muted">—</td></tr>
          <tr><td class="muted">—</td><td class="muted">—</td></tr>
          <tr><td class="muted">—</td><td class="muted">—</td></tr>
        </tbody>
      </table>
      <div class="muted" style="font-size:12px;margin-top:6px">* นับเมื่อ Max Peak ชนะและสูงเกิน Gate</div>
    </div>

    <!-- Score area -->
    <div id="rl-score">
      <div class="badge">Resonance Likelihood (Score)</div>
      <div class="score-grid" style="margin-top:10px">
        <div class="score-card" data-slot="0">
          <div class="score-top">
            <div class="hz-wrap"><span class="hz" data-hz>—</span> <span class="note" data-note></span></div>
            <span class="status-chip" data-status>—</span>
          </div>
          <div class="bigscore" data-score>—</div>
          <div class="bar"><div class="fill" data-bar></div></div>
          <div class="score-meta" data-meta>P:— • H:— • C:— • D:—</div>
        </div>
        <div class="score-card" data-slot="1">
          <div class="score-top">
            <div class="hz-wrap"><span class="hz" data-hz>—</span> <span class="note" data-note></span></div>
            <span class="status-chip" data-status>—</span>
          </div>
          <div class="bigscore" data-score>—</div>
          <div class="bar"><div class="fill" data-bar></div></div>
          <div class="score-meta" data-meta>P:— • H:— • C:— • D:—</div>
        </div>
        <div class="score-card" data-slot="2">
          <div class="score-top">
            <div class="hz-wrap"><span class="hz" data-hz>—</span> <span class="note" data-note></span></div>
            <span class="status-chip" data-status>—</span>
          </div>
          <div class="bigscore" data-score>—</div>
          <div class="bar"><div class="fill" data-bar></div></div>
          <div class="score-meta" data-meta>P:— • H:— • C:— • D:—</div>
        </div>
      </div>

      <div class="desc muted" style="margin-top:12px">
        คะแนนคิดจาก Prominence (0–12dB), Hold (0–3s), Count (เทียบกับอันดับสูงสุด), Decay (0–1.5s) — ถ่วงน้ำหนัก 30/30/20/20
        — ผลลัพธ์ขึ้นกับไมค์และสภาพแวดล้อม แนะนำใช้ร่วมกับการลองปรับ EQ/ยืนตำแหน่ง room mode
      </div>
    </div>

    <!-- Patch notes -->
    <div class="card" style="margin-top:18px">
      <div class="badge">บันทึกการปรับปรุง (patch notes)</div>
      <ul style="margin-top:8px">
        <li>ย่อขนาดการ์ดคะแนนให้จบในบรรทัดเดียวบนมือถือ</li>
        <li>ป้าย “เรโซแนนซ์/น่าสงสัย/เฝ้าดูต่อ” ย่ออัตโนมัติแต่ยังอ่านชัด</li>
        <li>แถบคะแนนเป็น gradient pill ฟ้า→ชมพู พร้อมเงา</li>
        <li>ล็อคความสูงการ์ดและตาราง (3 แถว) ไม่ให้เด้งเมื่อไม่มีข้อมูล</li>
      </ul>
    </div>

  </div>

<script>
/* ========= Utility ========= */
const A440 = 440;
const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function freqToNoteName(freq){
  if(!isFinite(freq) || freq<=0) return '';
  const n = Math.round(12 * Math.log2(freq / A440)) + 69; // MIDI
  const name = NOTE_NAMES[(n % 12 + 12) % 12];
  const octave = Math.floor(n/12)-1;
  return name + octave;
}
function noteToFreq(note){
  if(!note) return null;
  const m = note.trim().toUpperCase().match(/^([A-G])(#|B)?(\d)$/);
  if(!m) return null;
  let name = m[1];
  let accidental = m[2]||'';
  let octave = parseInt(m[3],10);
  if(accidental==='B'){ // flat
    const order = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    let i = order.indexOf(name);
    i = (i-1+12)%12;
    name = order[i][0];
    accidental = order[i].length>1 ? '#' : '';
  }
  const idx = NOTE_NAMES.indexOf(name + accidental);
  const n = idx + (octave+1)*12;
  return 440 * Math.pow(2,(n-69)/12);
}

/* ========= UI Elements ========= */
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const clearBtn = document.getElementById('clearBtn');
const gateSlider = document.getElementById('gate');
const gateVal = document.getElementById('gateVal');
const minHz = document.getElementById('minHz');
const maxHz = document.getElementById('maxHz');
const peaksBody = document.getElementById('peaksBody');
const winnersBody = document.getElementById('winnersBody');
const watchInput = document.getElementById('watchInput');
const addWatch = document.getElementById('addWatch');
const clearWatch = document.getElementById('clearWatch');
const watchChips = document.getElementById('watchChips');

gateVal.textContent = gateSlider.value + " dBFS";
gateSlider.addEventListener('input',()=>gateVal.textContent = gateSlider.value+" dBFS");

/* ========= Watchlist ========= */
let watchlist = [];
function renderWatchlist(){
  watchChips.innerHTML='';
  watchlist.forEach(w =>{
    const node = document.createElement('div');
    node.className='chip';
    node.textContent = isNaN(w)? w : `${w} Hz`;
    watchChips.appendChild(node);
  });
}
addWatch.onclick = ()=>{
  const v = watchInput.value.trim();
  if(!v) return;
  const hz = isNaN(+v) ? noteToFreq(v) : +v;
  watchlist.push(isNaN(+v) ? v.toUpperCase() : Math.round(hz));
  watchInput.value='';
  renderWatchlist();
};
clearWatch.onclick = ()=>{ watchlist=[]; renderWatchlist(); };

/* ========= Audio & Stats ========= */
let ctx, analyser, src, rafId;
let sampleRate=48000;
let fftSize = 8192;
let freqData, timeData;

const hist = new Map(); // key: rounded Hz -> stats
// stats: {count, lastSeen, hold, level, prom, promSum, holdSum, decaySum, hits, lastLevel}
const MAX_TRACK_AGE = 3000; // ms

function ensureStat(hz){
  const key = Math.round(hz);
  if(!hist.has(key)){
    hist.set(key, {count:0,lastSeen:0,hold:0,level:-120,prom:0,
      promSum:0,holdSum:0,decaySum:0,hits:0,lastLevel:-120});
  }
  return hist.get(key);
}

function clearStats(){
  hist.clear();
  updateTables([],[]);
  setScoreCards([]);
}
clearBtn.onclick = clearStats;

/* ========= Start/Stop ========= */
async function start(){
  if(ctx) return;
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  sampleRate = ctx.sampleRate;
  analyser = ctx.createAnalyser();
  analyser.fftSize = fftSize;
  analyser.smoothingTimeConstant = 0.88;
  src = ctx.createMediaStreamSource(stream);
  src.connect(analyser);
  freqData = new Float32Array(analyser.frequencyBinCount);
  timeData = new Float32Array(analyser.fftSize);
  stopBtn.disabled=false; startBtn.disabled=true;
  loop();
}
async function stop(){
  if(!ctx) return;
  cancelAnimationFrame(rafId);
  if(src && src.mediaStream) src.mediaStream.getTracks().forEach(t=>t.stop());
  ctx.close();
  ctx=null; startBtn.disabled=false; stopBtn.disabled=true;
}
startBtn.onclick = start;
stopBtn.onclick = stop;

/* ========= Analysis Loop ========= */
function loop(){
  rafId = requestAnimationFrame(loop);
  analyser.getFloatFrequencyData(freqData);
  const now = performance.now();
  const min = Math.max(1, +minHz.value || 40);
  const max = Math.max(min+1, +maxHz.value || 300);
  const gate = +gateSlider.value;
  const binHz = sampleRate / analyser.fftSize;
  const minBin = Math.max(1, Math.floor(min / binHz));
  const maxBin = Math.min(freqData.length-2, Math.floor(max / binHz));

  // find peaks
  const peaks = [];
  for(let i=minBin+1;i<maxBin-1;i++){
    const l = freqData[i-1], c=freqData[i], r=freqData[i+1];
    if(c>l && c>r){
      const prom = c - Math.max(l,r);
      const hz = i*binHz;
      peaks.push({hz, level:c, prom});
    }
  }
  // sort by level, take top 3
  peaks.sort((a,b)=>b.level-a.level);
  const top = peaks.slice(0,3);

  // Update histogram & winners
  if(top.length){
    // winner
    const winner = top[0];
    if(winner.level >= gate){
      const s = ensureStat(winner.hz);
      s.count++;
    }
    // update per peak
    top.forEach(p=>{
      const s = ensureStat(p.hz);
      const dt = s.lastSeen ? (now - s.lastSeen)/1000 : 0;
      if(dt<0.2){ // merge within small time window
        s.hold += dt;
      }else{
        s.hold = Math.min(3, s.hold + Math.min(dt,0.3));
      }
      // decay = previous - current if dropping, clamp
      const drop = Math.max(0, (s.lastLevel - p.level));
      s.decaySum += Math.min(1.5, drop/30); // coarse
      s.prom = p.prom;
      s.promSum += Math.max(0, Math.min(12,p.prom));
      s.level = p.level;
      s.lastLevel = p.level;
      s.lastSeen = now;
      s.hits++;
    });
  }

  // cleanup old
  for(const [k,s] of [...hist]){
    if(now - s.lastSeen > MAX_TRACK_AGE) hist.delete(k);
  }

  // derive current 3 peaks rows
  const curRows = top.map(p=>{
    return {
      hz: Math.round(p.hz),
      level: p.level.toFixed(1),
      prom: p.prom.toFixed(1),
      hold: ensureStat(p.hz).hold.toFixed(2),
      decay: ensureStat(p.hz).decaySum.toFixed(2)
    };
  });
  updateTables(curRows, getTopWinners());

  // compute scores
  const scores = computeScores();
  setScoreCards(scores.slice(0,3));
}

function getTopWinners(){
  const arr = [...hist.entries()].map(([hz,s])=>({hz, count:s.count}));
  arr.sort((a,b)=>b.count-a.count);
  return arr.slice(0,3);
}

function updateTables(rows, winners){
  // peaks rows (always 3 rows, keep layout fixed)
  const out = [];
  for(let i=0;i<3;i++){
    const r = rows[i];
    if(r){
      out.push(`<tr>
        <td>${r.hz} <span class="note-badge">${freqToNoteName(r.hz)}</span></td>
        <td>${r.level}</td>
        <td>${r.prom}</td>
        <td>${r.hold}</td>
        <td>${r.decay}</td>
      </tr>`);
    }else{
      out.push(`<tr><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td><td class="muted">—</td></tr>`);
    }
  }
  peaksBody.innerHTML = out.join('');

  // winners rows (always 3)
  const wout = [];
  for(let i=0;i<3;i++){
    const w = winners[i];
    if(w){
      wout.push(`<tr><td>${w.hz} <span class="note-badge">${freqToNoteName(w.hz)}</span></td><td>${w.count}</td></tr>`);
    }else{
      wout.push(`<tr><td class="muted">—</td><td class="muted">—</td></tr>`);
    }
  }
  winnersBody.innerHTML = wout.join('');
}

/* ========= Score Model ========= */
function computeScores(){
  // convert hist to scores
  const items = [];
  const gate = +gateSlider.value;
  const maxCount = Math.max(1, ...[...hist.values()].map(s=>s.count));
  for(const [hz,s] of hist){
    // ignore very low-level bins never above gate
    if(s.level < gate && s.count==0 && s.promSum===0) continue;
    const P = Math.min(100, (s.promSum / Math.max(1,s.hits)) / 12 * 100); // avg prom->%
    const H = Math.min(100, (s.holdSum? s.holdSum : s.hold) / 3 * 100);
    const C = Math.min(100, s.count / maxCount * 100);
    const D = Math.min(100, (s.decaySum / 1.5) * 100);

    const score = 0.30*P + 0.30*H + 0.20*C + 0.20*D;
    items.push({
      hz, score,
      P:Math.round(P), H:Math.round(H), C:Math.round(C), D:Math.round(D)
    });
  }
  items.sort((a,b)=>b.score-a.score);
  return items;
}

function setScoreCards(items){
  const cards = document.querySelectorAll('.score-card');
  for(let i=0;i<cards.length;i++){
    const c = cards[i];
    const data = items[i];
    const hzEl = c.querySelector('[data-hz]');
    const noteEl = c.querySelector('[data-note]');
    const statusEl = c.querySelector('[data-status]');
    const scoreEl = c.querySelector('[data-score]');
    const barEl = c.querySelector('[data-bar]');
    const metaEl = c.querySelector('[data-meta]');
    if(data){
      hzEl.textContent = data.hz + " Hz";
      noteEl.textContent = `(${freqToNoteName(data.hz)})`;
      scoreEl.textContent = (Math.round(data.score*10)/10).toFixed(1);
      barEl.style.width = Math.max(2, Math.min(100, data.score)) + '%';
      metaEl.textContent = `P:${data.P}% • H:${data.H}% • C:${data.C}% • D:${data.D}%`;
      // status chip
      if(data.score>=70){statusEl.textContent='เรโซแนนซ์'; statusEl.style.color='#d6f8ff'}
      else if(data.score>=40){statusEl.textContent='น่าสงสัย'}
      else {statusEl.textContent='เฝ้าดูต่อ'}
    }else{
      hzEl.textContent='—'; noteEl.textContent=''; scoreEl.textContent='—';
      barEl.style.width='0%'; metaEl.textContent='P:— • H:— • C:— • D:—';
      statusEl.textContent='—';
    }
  }
}
</script>
</body>
</html>
