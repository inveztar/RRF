<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Resonance Finder (Backup)</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--card:#0c1426;--text:#e5e7eb;--muted:#9ca3af;--border:rgba(255,255,255,.08);
    --accent:#60a5fa;--good:#10b981;--warn:#f59e0b;--bad:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);
       font-family:UI-Sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Noto Sans",Arial}
  a{color:#93c5fd}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 6px;font-size:28px} .sub{margin:0 0 16px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:14px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  select,input[type="number"],input[type="text"]{
    padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);
  }
  input[type="range"]{width:200px}
  button{border:none;border-radius:12px;padding:9px 14px;font-weight:600;cursor:pointer}
  .btn{background:var(--accent);color:#06111e}
  .ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .ok{background:var(--good);color:#052217}
  .warn{background:var(--warn);color:#241600}
  .danger{background:var(--bad);color:white}
  .pill{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:7px 12px}
  .grid{display:grid;gap:12px;grid-template-columns:1.15fr .85fr} @media(max-width:980px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
  th,td{padding:9px 8px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  th{color:#cbd5e1}
  tbody tr{height:32px}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);
        padding:4px 8px;border-radius:10px;font-size:12px;margin:4px 6px 0 0}
  .chip button{background:transparent;color:var(--muted);border:none;padding:0;cursor:pointer}
  .section-title{font-weight:700;margin:4px 0 10px}
  .mono{font-family:ui-monospace, Menlo, Consolas, "SFMono-Regular", monospace}
  .footer{color:var(--muted);font-size:12px;margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Room Resonance Finder</h1>
  <p class="sub">ค้นหาเรโซแนนซ์ของห้องแบบเรียลไทม์จากไมโครโฟน — เลือกช่วงความถี่, เกณฑ์ความเด่น (Prominence), และดูคำแนะนำ PEQ คร่าว ๆ</p>

  <div class="row" style="margin-bottom:10px">
    <button id="btnStart" class="ok">เริ่มวัด</button>
    <button id="btnStop"  class="ghost">หยุด</button>
    <button id="btnFreeze" class="pill">Freeze Peaks</button>
    <button id="btnClear"  class="pill">Clear</button>
    <span id="status" class="pill" style="pointer-events:none">ไมค์: OFF</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>FFT Size</label>
          <select id="fft">
            <option value="4096">4096</option>
            <option value="8192" selected>8192 (แนะนำ)</option>
            <option value="16384">16384</option>
          </select>
          <div class="hint">FFT ใหญ่ขึ้น → ความละเอียดความถี่ดีขึ้น (แต่จะหน่วงขึ้นเล็กน้อย)</div>
        </div>

        <div>
          <label>ช่วงความถี่</label>
          <select id="range">
            <option value="20,300" selected>20 – 300 Hz</option>
            <option value="20,500">20 – 500 Hz</option>
            <option value="40,300">40 – 300 Hz</option>
            <option value="20,2000">20 – 2k Hz</option>
            <option value="custom">กำหนดเอง…</option>
          </select>
          <div class="row">
            <input id="minHz" type="number" value="20" min="1" style="width:90px">
            <input id="maxHz" type="number" value="300" min="50" style="width:90px">
          </div>
        </div>

        <div>
          <label>Prominence ≥ <span id="promVal">6</span> dB</label>
          <input id="prom" type="range" min="0" max="20" step="0.5" value="6">
        </div>

        <div>
          <label>Top-N Peaks</label>
          <select id="topN">
            <option>3</option>
            <option selected>5</option>
            <option>7</option>
            <option>10</option>
          </select>
        </div>

        <div>
          <label>Averaging</label>
          <select id="avg">
            <option value="0">None</option>
            <option value="4">4×</option>
            <option value="8" selected>8×</option>
            <option value="16">16×</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Watchlist (เฝ้าความถี่/โน้ต)</div>
      <div class="row">
        <div>
          <label>Hz</label>
          <input id="hzInput" type="text" placeholder="เช่น 116 หรือ 116.5">
        </div>
        <div>
          <label>NOTE</label>
          <input id="noteInput" type="text" placeholder="เช่น Bb2 / A#2 / B2">
        </div>
        <div style="align-self:flex-end">
          <button id="btnAddHz" class="btn">Add</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnAddNote" class="ghost">Add Note</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnClearWatch" class="ghost">Clear Watchlist</button>
        </div>
      </div>
      <div class="hint">พิมพ์โน้ต (เช่น <span class="mono">Bb2</span>) หรือ Hz ตรง ๆ แล้ว Add ได้เลย</div>
      <div id="watchChips" class="row" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="section-title" style="margin:0">ผลพีค / ค่าที่น่าสงสัย</div>
      <div class="hint" id="infoText">—</div>
    </div>
    <div style="overflow:auto">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Hz</th>
            <th>Level (dBFS)</th>
            <th>Prom.</th>
            <th>Hold (s)</th>
            <th>แนะนำ EQ</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    เคล็ดลับ: ใช้หูฟัง/ปิดลำโพงเพื่อลด feedback, ขยับไมค์เล็กน้อยเพื่อยืนยันว่าเป็นพีคจากห้องจริง ๆ |
    โค้ดทำงานในเบราว์เซอร์ ใช้ไมค์ของคุณแบบ local เท่านั้น
  </div>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const rowsEl = $("#rows");
  const statusEl = $("#status");
  const infoEl = $("#infoText");

  const state = {
    ctx: null, src: null, analyser: null, raf: 0, running: false,
    sampleRate: 48000, binHz: 0, freeze: false,
    lastFrameTime: performance.now(), avgBuf: null, avgN: 8,
    holdMap: new Map(), lastDb: null, watch: [],
    // NEW: fixed rows pool (3 rows)
    rowPool: []
  };

  function midiFromNoteName(name) {
    if (!name) return null;
    name = name.trim().toUpperCase().replace(/＃/g, '#').replace(/Ｂ/g,'B').replace(/♯/g,'#').replace(/♭/g,'B');
    const m = name.match(/^([A-G])([#B]?)(-?\d{1,2})$/);
    if (!m) return null;
    const map = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
    let sem = map[m[1]]; if (m[2] === '#') sem += 1; if (m[2] === 'B') sem -= 1;
    const midi = (parseInt(m[3],10)+1)*12 + sem;
    return midi;
  }
  const hzFromMidi = m => 440 * Math.pow(2, (m-69)/12);
  function hzFromNoteName(name) { const m = midiFromNoteName(name); return m==null ? null : hzFromMidi(m); }
  function hzToNoteName(hz) {
    const m = 69 + 12 * Math.log2(hz/440), mi = Math.round(m);
    const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const name = names[(mi%12+12)%12]; const oct = Math.floor(mi/12)-1; return `${name}${oct}`;
  }
  function dbToLin(db){ return Math.pow(10, db/20); }
  function linToDb(lin){ return 20*Math.log10(Math.max(lin, 1e-12)); }

  function addWatchHz(f) {
    if (!isFinite(f) || f<=0) return;
    if (state.watch.some(w => Math.abs(w.f-f) < 0.5)) return;
    state.watch.push({f: +f}); renderWatch();
  }
  function addWatchNote(txt) { const f = hzFromNoteName(txt); if (f) addWatchHz(f); }
  function clearWatch(){ state.watch = []; renderWatch(); }
  function removeWatch(idx){ state.watch.splice(idx,1); renderWatch(); }
  function renderWatch(){
    const box = $("#watchChips"); box.innerHTML = "";
    state.watch.sort((a,b)=>a.f-b.f).forEach((w, idx)=>{
      const d = document.createElement("div");
      d.className = "chip";
      d.innerHTML = `<span class="mono">${w.f.toFixed(2)} Hz</span> <span class="muted">(${hzToNoteName(w.f)})</span> <button aria-label="remove">&times;</button>`;
      d.querySelector("button").onclick = ()=>removeWatch(idx);
      box.appendChild(d);
    });
  }

  async function start() {
    if (state.running) return;
    const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
    state.ctx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'interactive'});
    state.sampleRate = state.ctx.sampleRate;
    state.src = state.ctx.createMediaStreamSource(stream);
    state.analyser = state.ctx.createAnalyser();
    state.analyser.fftSize = parseInt($("#fft").value,10);
    state.analyser.smoothingTimeConstant = 0;
    state.src.connect(state.analyser);
    updateBinHz(); setupAvg();
    state.running = true;
    statusEl.textContent = `ไมค์: ON @ ${state.sampleRate} Hz`;
    state.lastFrameTime = performance.now();
    ensureRows(3); // fixed 3 rows once at start
    loop();
  }
  function stop() {
    state.running = false; cancelAnimationFrame(state.raf);
    if (state.ctx) { state.ctx.close().catch(()=>{}); state.ctx = null; }
    statusEl.textContent = "ไมค์: OFF";
  }
  function updateBinHz(){ state.binHz = (state.sampleRate/2) / state.analyser.frequencyBinCount; }
  function setupAvg(){ const n = parseInt($("#avg").value,10); state.avgN = Math.max(0, n|0); state.avgBuf = null; }
  function setFftSize(size){ if (!state.analyser) return; state.analyser.fftSize = size; updateBinHz(); state.avgBuf = null; }

  function pickPeaks(db, minHz, maxHz, promTh, topN) {
    const n = db.length;
    const iMin = Math.max(1, Math.floor(minHz / state.binHz));
    const iMax = Math.min(n-2, Math.ceil(maxHz / state.binHz));
    const peaks = [];
    for (let i=iMin; i<=iMax; i++){
      const v = db[i];
      if (!(v>db[i-1] && v>db[i+1])) continue;
      let left = v, right = v; let j=i;
      while (j>iMin && db[j-1] < left) { left = db[--j]; }
      j=i; while (j<iMax && db[j+1] < right) { right = db[++j]; }
      const base = Math.max(left, right);
      const prom = v - base;
      if (prom >= promTh) { peaks.push({ i, f: i*state.binHz, v, prom }); }
    }
    peaks.sort((a,b)=>b.prom - a.prom);
    return peaks.slice(0, topN);
  }
  function estimateQ(db, idx){
    const v = db[idx], th = v - 3; let l=idx, r=idx;
    while (l>1 && db[l] > th) l--; while (r<db.length-2 && db[r] > th) r++;
    const f0 = idx * state.binHz; const bw = Math.max((r-l)*state.binHz, 1e-6);
    return Math.max(1, Math.min(f0 / bw, 20));
  }
  function nearestLevel(db, f){ const i = Math.max(0, Math.min(db.length-1, Math.round(f/state.binHz))); return db[i]; }

  // NEW: create and keep exactly 3 rows, update cells in place
  function ensureRows(n){
    if (state.rowPool.length === n) return;
    rowsEl.innerHTML = ""; state.rowPool = [];
    for (let i=0; i<n; i++){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono hz">—</td>
        <td class="mono lv">—</td>
        <td class="mono pm">—</td>
        <td class="mono hd">—</td>
        <td class="mono eq">—</td>`;
      rowsEl.appendChild(tr);
      state.rowPool.push({
        hz: tr.children[0], lv: tr.children[1], pm: tr.children[2], hd: tr.children[3], eq: tr.children[4]
      });
    }
  }

  function renderTable(peaks, dt) {
    if (state.freeze) return;
    // Update hold timers
    const newHold = new Map();
    for (const p of peaks){
      const key = Math.round(p.f);
      const prev = state.holdMap.get(key) || 0;
      newHold.set(key, prev + dt);
      p.hold = prev + dt;
    }
    state.holdMap = newHold;

    // Keep exactly 3 display rows, fill with — if not enough peaks
    ensureRows(3);
    // Sort by frequency to keep stable visual order
    const disp = peaks.slice(0,3).sort((a,b)=>a.f-b.f);
    for (let i=0;i<3;i++){
      const cell = state.rowPool[i];
      if (i < disp.length){
        const p = disp[i];
        const Q = estimateQ(state.lastDb, p.i);
        const suggested = Math.max(-6, -Math.round(p.prom/1.2));
        cell.hz.innerHTML = `${p.f.toFixed(1)} <span class="muted">(${hzToNoteName(p.f)})</span>`;
        cell.lv.textContent = p.v.toFixed(1);
        cell.pm.textContent = p.prom.toFixed(1);
        cell.hd.textContent = (p.hold||0).toFixed(1);
        cell.eq.textContent = `~ PEQ: ${p.f.toFixed(0)} Hz, Q≈${Q.toFixed(1)}, ${suggested} dB`;
      } else {
        cell.hz.textContent = "—"; cell.lv.textContent = "—"; cell.pm.textContent = "—"; cell.hd.textContent = "—"; cell.eq.textContent = "—";
      }
    }

    // watchlist readout
    if (state.watch.length){
      const info = state.watch.map(w=>{
        const lv = nearestLevel(state.lastDb, w.f);
        return `${w.f.toFixed(1)}Hz: ${lv.toFixed(1)} dB`;
      }).join(" | ");
      infoEl.textContent = "Watchlist → " + info;
    } else infoEl.textContent = "—";
  }

  function loop(){
    if (!state.running) return;
    state.raf = requestAnimationFrame(loop);

    const n = state.analyser.frequencyBinCount;
    if (!state.lastDb || state.lastDb.length!==n) state.lastDb = new Float32Array(n);
    state.analyser.getFloatFrequencyData(state.lastDb);

    if (state.avgN>0){
      if (!state.avgBuf || state.avgBuf.length!==n) state.avgBuf = new Float32Array(n);
      for (let i=0;i<n;i++){
        const lin = dbToLin(state.lastDb[i]);
        state.avgBuf[i] = (state.avgBuf[i]*(state.avgN-1) + lin)/state.avgN;
        state.lastDb[i] = linToDb(state.avgBuf[i]);
      }
    }

    const minHz = parseFloat($("#minHz").value);
    const maxHz = parseFloat($("#maxHz").value);
    const promTh = parseFloat($("#prom").value);
    const topN = Math.max(3, parseInt($("#topN").value,10)); // pick at least 3 peaks for stable rows
    const now = performance.now();
    const dt = Math.min(1, (now - state.lastFrameTime)/1000);
    state.lastFrameTime = now;

    const peaks = pickPeaks(state.lastDb, minHz, maxHz, promTh, topN);
    renderTable(peaks, dt);
  }

  // UI
  $("#btnStart").onclick = start;
  $("#btnStop").onclick = stop;

  $("#fft").onchange = e => setFftSize(parseInt(e.target.value,10));
  $("#avg").onchange = setupAvg;
  $("#prom").oninput = e => $("#promVal").textContent = e.target.value;
  $("#range").onchange = e=>{
    const v = e.target.value; if (v==="custom") return;
    const [a,b] = v.split(",").map(Number); $("#minHz").value = a; $("#maxHz").value = b;
  };
  $("#btnFreeze").onclick = ()=>{ state.freeze = !state.freeze; $("#btnFreeze").textContent = state.freeze ? "Unfreeze" : "Freeze Peaks"; };
  $("#btnClear").onclick = ()=>{ state.holdMap.clear(); /* keep rows; just clear texts */ ensureRows(3); for(const r of state.rowPool){ r.hz.textContent=r.lv.textContent=r.pm.textContent=r.hd.textContent=r.eq.textContent="—"; } };

  $("#btnAddHz").onclick = ()=>{ const f = parseFloat($("#hzInput").value.trim()); if (isFinite(f)) addWatchHz(f); $("#hzInput").value=""; };
  $("#btnAddNote").onclick = ()=>{ addWatchNote($("#noteInput").value.trim()); $("#noteInput").value=""; };
  $("#btnClearWatch").onclick = clearWatch;

  // Auto-sleep mic after page hidden 60s
  let hideTimer = null;
  document.addEventListener("visibilitychange", ()=>{
    if (document.hidden){ hideTimer = setTimeout(()=>{ if(state.running) stop(); }, 60_000); }
    else{ if (hideTimer) { clearTimeout(hideTimer); hideTimer=null; } }
  });

  // Preset anchors (can remove if not needed)
  addWatchHz(116.54); addWatchHz(233.08); addWatchHz(349.62);
})();
</script>
</body>
</html>
